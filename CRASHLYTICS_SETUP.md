# Firebase Crashlytics Setup

Firebase Crashlytics is now integrated into the app for production error monitoring and crash reporting.

## Features

### Automatic Error Reporting
- **Fatal Errors**: All uncaught Flutter framework errors are automatically reported
- **Async Errors**: Uncaught asynchronous errors are captured and reported
- **Non-Fatal Errors**: Custom errors logged via `AppLogger.error()` are reported
- **Stack Traces**: Full stack traces included for debugging
- **Platform Support**: Works on iOS and Android (skipped on Web)

### Integration with AppLogger

All errors logged through `AppLogger.error()` are automatically sent to Crashlytics:

```dart
// Automatically sent to Crashlytics in production
AppLogger.error('Failed to load route',
  tag: 'NAVIGATION',
  error: e,
  stackTrace: stackTrace
);

// Mark as fatal error (higher priority in Crashlytics)
AppLogger.error('Critical failure',
  tag: 'GPS',
  error: e,
  fatal: true
);
```

## How It Works

### 1. Initialization (main.dart)

Crashlytics is initialized after Firebase Core:

```dart
// Crashlytics only runs on native platforms (iOS/Android)
if (!kIsWeb) {
  // Capture Flutter framework errors
  FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;

  // Capture async errors
  PlatformDispatcher.instance.onError = (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
    return true;
  };
}
```

### 2. AppLogger Integration (utils/app_logger.dart)

The `AppLogger.error()` method automatically reports to Crashlytics:

- **Debug Mode**: Logs to console with formatting
- **Release Mode**: Silently sends to Crashlytics
- **Web Platform**: Skips Crashlytics (not supported)

### 3. Error Categorization

Errors are tagged with context for easier filtering in Firebase Console:

- `[GPS]` - Location and GPS tracking errors
- `[NAVIGATION]` - Navigation and routing errors
- `[REROUTE]` - Automatic rerouting failures
- `[FIREBASE]` - Firebase initialization/connection errors
- `[API]` - Network and API call failures
- `[HAZARD]` - Hazard detection errors
- `[POI]` - Point of Interest errors

## Viewing Crash Reports

### Firebase Console

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Navigate to **Crashlytics** in the left sidebar
4. View crashes by:
   - **Issue type** (crash vs non-fatal error)
   - **Version** (app version)
   - **Device** (iOS vs Android)
   - **Tags** (GPS, NAVIGATION, etc.)

### Report Types

- **Crashes**: Fatal errors that caused app to terminate
- **Non-Fatals**: Errors caught and handled by the app
- **Velocity Alerts**: Sudden spike in crash rate

## Testing Crashlytics

### Force a Test Crash (Debug Only)

Add this button to your debug UI:

```dart
// DO NOT use in production!
if (kDebugMode) {
  ElevatedButton(
    onPressed: () {
      FirebaseCrashlytics.instance.crash();
    },
    child: Text('Test Crash'),
  );
}
```

### Test Non-Fatal Error

```dart
try {
  throw Exception('Test error for Crashlytics');
} catch (e, stack) {
  AppLogger.error('Test error',
    tag: 'TEST',
    error: e,
    stackTrace: stack
  );
}
```

### Viewing Test Reports

**Important**: Crashlytics reports may take a few minutes to appear in the Firebase Console, especially for debug builds.

1. Trigger a test crash or error
2. Restart the app (this uploads the crash report)
3. Wait 2-5 minutes
4. Check Firebase Console â†’ Crashlytics

## Configuration Files

### iOS
- **GoogleService-Info.plist**: Located in `ios/Runner/`
- **Pods**: Crashlytics automatically installed via CocoaPods

### Android
- **google-services.json**: Should be in `android/app/` (if using Firebase config files)

### All Platforms
- **firebase_options.dart**: Generated by FlutterFire CLI, contains all configuration
- Used by default with `DefaultFirebaseOptions.currentPlatform`

## Build Configuration

### iOS Release Build

```bash
flutter build ios --release \
  --dart-define=THUNDERFOREST_API_KEY="$THUNDERFOREST_API_KEY" \
  --dart-define=MAPTILER_API_KEY="$MAPTILER_API_KEY" \
  --dart-define=MAPBOX_ACCESS_TOKEN="$MAPBOX_ACCESS_TOKEN" \
  --dart-define=LOCATIONIQ_API_KEY="$LOCATIONIQ_API_KEY" \
  --dart-define=GRAPHHOPPER_API_KEY="$GRAPHHOPPER_API_KEY"
```

Or use the build script:

```bash
./build_ios.sh
```

### Android Release Build

```bash
flutter build apk --release \
  --dart-define=THUNDERFOREST_API_KEY="$THUNDERFOREST_API_KEY" \
  --dart-define=MAPTILER_API_KEY="$MAPTILER_API_KEY" \
  --dart-define=MAPBOX_ACCESS_TOKEN="$MAPBOX_ACCESS_TOKEN" \
  --dart-define=LOCATIONIQ_API_KEY="$LOCATIONIQ_API_KEY" \
  --dart-define=GRAPHHOPPER_API_KEY="$GRAPHHOPPER_API_KEY"
```

## Troubleshooting

### Reports Not Appearing

1. **Wait**: Crashlytics can take 2-5 minutes to process reports
2. **Restart App**: Crash reports are uploaded on next app launch
3. **Check Internet**: Device needs network connection to upload
4. **Verify Initialization**: Check logs for "Crashlytics initialized successfully"

### Common Issues

#### "FirebaseCrashlytics not initialized"
- Ensure Firebase is initialized before Crashlytics
- Check `firebase_options.dart` exists
- Verify `GoogleService-Info.plist` (iOS) or `google-services.json` (Android)

#### No crashes in console
- Crashlytics is disabled on web platform (expected)
- Debug builds may have delays
- Check Firebase Console project matches your app's bundle ID

#### Duplicate symbols (iOS)
- Run `cd ios && pod install && cd ..`
- Clean build: `flutter clean && flutter pub get`

## Privacy & Data

### What Gets Sent

- Exception type and message
- Stack trace
- Device model and OS version
- App version
- Timestamp
- User ID (if set with `FirebaseCrashlytics.instance.setUserIdentifier()`)

### What's NOT Sent

- Personal user data (unless explicitly included in error messages)
- API keys (removed from source code)
- User location data (unless in error context)

### GDPR Compliance

To opt users out of Crashlytics:

```dart
await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(false);
```

## Next Steps

1. **Monitor**: Check Firebase Console regularly for new issues
2. **Set Alerts**: Configure velocity alerts for crash spikes
3. **Custom Keys**: Add custom keys for better context:
   ```dart
   FirebaseCrashlytics.instance.setCustomKey('route_type', 'fastest');
   ```
4. **User IDs**: Set anonymous user IDs to track affected users:
   ```dart
   FirebaseCrashlytics.instance.setUserIdentifier('user_123');
   ```

## Resources

- [Firebase Crashlytics Documentation](https://firebase.google.com/docs/crashlytics)
- [FlutterFire Crashlytics](https://firebase.flutter.dev/docs/crashlytics/overview)
- [Testing Crashlytics](https://firebase.google.com/docs/crashlytics/test-implementation)
